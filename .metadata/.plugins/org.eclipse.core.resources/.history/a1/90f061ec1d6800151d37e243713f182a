package project.strategies;

import java.util.ArrayList;
import java.util.List;

import javax.ejb.EJB;
import javax.naming.InitialContext;
import javax.naming.NamingException;

import project.business.StockBeanLocal;
import project.entity.Stock;

@EJB(name="ejb/Stock", beanInterface=StockBeanLocal.class)
public class TwoMovingAverage extends Strategy {
	
	private String stock;
	private int shortLength;
	private int longLength;
	private List<Double> shortPrices = new ArrayList<>();
	private List<Double> longPrices = new ArrayList<>();
	private boolean active = false;
	
	
	public TwoMovingAverage(String stock, int shortTime, int longTime) {
		this.shortLength = shortTime;
		this.longLength = longTime;
		this.active = true;
	}
	
	
	public String getStock() {
		return stock;
	}

	public void setStock(String stock) {
		this.stock = stock;
	}

	public int getShortLength() {
		return shortLength;
	}

	public void setShortLength(int shortLength) {
		this.shortLength = shortLength;
	}

	public int getLongLength() {
		return longLength;
	}

	public void setLongLength(int longLength) {
		this.longLength = longLength;
	}
	
	public List<Double> getShortPrices() {
		return shortPrices;
	}

	public void setShortPrices(List<Double> shortPrices) {
		this.shortPrices = shortPrices;
	}

	public List<Double> getLongPrices() {
		return longPrices;
	}

	public void setLongPrices(List<Double> longPrices) {
		this.longPrices = longPrices;
	}
	
	//Duration is set to minutes
	public void calcMovingAverage(Stock s, long startTime, int shortDuration, int longDuration) {
		InitialContext context;
		StockBeanLocal bean;
		
		try {
			context = new InitialContext();
			bean = (StockBeanLocal)context.lookup("java:comp/env/ejb/Stock");
			
			if((System.currentTimeMillis()-startTime) >= shortDuration*60*1000) {
	        	List<Stock> shortAvgStocks = new ArrayList<Stock>();
	        	shortAvgStocks = bean.retrieveMovingAvgStock(shortDuration, s.getStockSymbol());
	        	
	        	double shortAvg = super.calcMovingAverage(shortAvgStocks);
	        	shortPrices.add(shortAvg);
	        	s.setMovingAvg(shortAvg);
	        }
			
			if((System.currentTimeMillis()-startTime) >= longDuration*60*1000) {
	        	List<Stock> shortAvgStocks = new ArrayList<Stock>();
	        	shortAvgStocks = bean.retrieveMovingAvgStock(longDuration, s.getStockSymbol());
	        	
	        	double shortAvg = super.calcMovingAverage(shortAvgStocks);
	        	longPrices.add(shortAvg);
	        	s.setMovingAvg(shortAvg);
	        }
		} catch (NamingException e) {
			System.out.println("Error occurred when calculating short moving average");
		}
	}
}
